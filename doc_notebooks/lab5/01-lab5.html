

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lab 5: Daisyworld &mdash; Numeric course 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Weekly notes" href="../../week_notes.html" />
    <link rel="prev" title="Solving Ordinary Differential Equations with the Runge-Kutta Methods" href="../lab4/01-lab4.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Numeric course
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../course_bootstrap.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ugradsyllabus20.html">Undergrad Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gradsyllabus20.html">Grad Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schedule20.html">Detailed Schedule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../texts.html">Optional texts</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../notebook_toc.html">Course/lab descriptions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../lab1/01-lab1.html">Lab 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab2/01-lab2.html">Lab 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab3/01-lab3.html">Lab 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab4/01-lab4.html">Lab 4</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Lab 5</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Assignment">Assignment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Objectives">Objectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Readings">Readings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#List-of-Problems">List of Problems</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#The-Daisyworld-Model">The Daisyworld Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#The-Daisy-Population">The Daisy Population</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Running-the-constant-growth-rate-demo">Running the constant growth rate demo</a></li>
<li class="toctree-l4"><a class="reference internal" href="#The-Daisy-Growth-Rate---Coupling-to-the-Environment">The Daisy Growth Rate - Coupling to the Environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#The-Local-Temperature---Dependence-on-Surface-Heat-Conductivity">The Local Temperature - Dependence on Surface Heat Conductivity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#The-Feedback-Loop---Feedback-Through-the-Planetary-Albedo">The Feedback Loop - Feedback Through the Planetary Albedo</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Adaptive-Stepsize-in-Runge-Kutta">Adaptive Stepsize in Runge-Kutta</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Why-Adaptive-Stepsize?">Why Adaptive Stepsize?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Designing-Adaptive-Stepsize-Control">Designing Adaptive Stepsize Control</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Error-Estimate-by-Step-Doubling">Error Estimate by Step Doubling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Error-Estimate-using-Embedded-Runge-Kutta">Error Estimate using Embedded Runge-Kutta</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Using-Error-to-Adjust-the-Stepsize">Using Error to Adjust the Stepsize</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Coding-Runge-Kutta-Adaptive-Stepsize-Control">Coding Runge-Kutta Adaptive Stepsize Control</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Daisyworld-Steady-States">Daisyworld Steady States</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Neutral-Daisies">Neutral Daisies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Black-Daisies">Black Daisies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#White-Daisies">White Daisies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Black-and-White-Daisies">Black and White Daisies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Conclusion">Conclusion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Appendix:-Note-on-Global-Energy-Balance">Appendix: Note on Global Energy Balance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Summary:-Daisy-World-Equations">Summary: Daisy World Equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Appendix:-Organization-of-the-adaptive-Runge-Kutta-routines">Appendix: Organization of the adaptive Runge Kutta routines</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Appendix:-2-minute-intro-to-object-oriented-programming">Appendix: 2 minute intro to object oriented programming</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Classes-and-constructors">Classes and constructors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-the-attributes-and-methods-of-a-class-instance">finding the attributes and methods of a class instance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Inheritance">Inheritance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Initializing-using-yaml">Initializing using yaml</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Overriding-initial-values-in-a-derived-class">Overriding initial values in a derived class</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Why-bother?">Why bother?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week_notes.html">Weekly notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../assignments.html">Weekly assignments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quizzes.html">Quizzes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Numeric course</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../notebook_toc.html">Numeric notebooks</a> &raquo;</li>
        
      <li>Lab 5: Daisyworld</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/doc_notebooks/lab5/01-lab5.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Lab-5:-Daisyworld">
<h1>Lab 5: Daisyworld<a class="headerlink" href="#Lab-5:-Daisyworld" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Assignment">
<h2>Assignment<a class="headerlink" href="#Assignment" title="Permalink to this headline">¶</a></h2>
<p>Upload a jupyter notebook that solves the following problems – if you want to import your own module code, include that with the notebook in a zipfile</p>
<p>Undergrads: Upload a notebook (and, if you modify library files, include that) * A409: do Problems 1 (constant), 2 (coupling), 4 (initial), 5 (temperature), 6 (estimate) * E511: do Problems 1 (constant), 2 (coupling), 4 (initial), 5 (temperature), 6 (estimate), 8 (adaptive), 9 (predators)</p>
</div>
<div class="section" id="Objectives">
<h2>Objectives<a class="headerlink" href="#Objectives" title="Permalink to this headline">¶</a></h2>
<p>In this lab, you will explore a simple environmental model, <em>Daisyworld</em>, with the help of a Runge-Kutta method with adaptive stepsize control.</p>
<p>The goal is for you to gain some experience using a Runge-Kutta integrator and to see the advantages of applying error control to the algorithm. As well, you will discover the the possible insights one can garner from the study of numerical solutions of a physical model.</p>
<p>In particular you will be able to:</p>
<ul class="simple">
<li><p>explain how the daisies affect the climate in the daisy world model</p></li>
<li><p>define adaptive step-size model</p></li>
<li><p>explain for what reasons an adaptive step-size model maybe faster for given accuracy</p></li>
<li><p>explain why white daisies (alone) can survive at a higher solar constant than black daisies</p></li>
<li><p>define hysteresis</p></li>
</ul>
</div>
<div class="section" id="Readings">
<h2>Readings<a class="headerlink" href="#Readings" title="Permalink to this headline">¶</a></h2>
<p>There is no required reading for this lab, beyond the contents of the lab itself. However, if you would like additional background on any of the following topics, then refer to the sections indicated below:</p>
<ul class="simple">
<li><p><strong>Daisy World:</strong></p>
<ul>
<li><p>The original article by <a class="reference external" href="http://ezproxy.library.ubc.ca/login?url=http://onlinelibrary.wiley.com/enhanced/doi/10.1111/j.1600-0889.1983.tb00031.x">Watson and Lovelock, 1983</a> which derive the equations used here.</p></li>
<li><p>A 2008 Reviews of Geophysics article by <a class="reference external" href="http://ezproxy.library.ubc.ca/login?url=http://doi.wiley.com/10.1029/2006RG000217">Wood et al.</a> with more recent developments (species competition, etc.)</p></li>
</ul>
</li>
<li><p><strong>Runge-Kutta Methods with Adaptive Stepsize Control:</strong></p>
<ul>
<li><p>Newman, Section 8.4</p></li>
<li><p>Press, et al. Section 16.2: these are equations we implemented in Python, <a class="reference external" href="pdfs/adapt_ode.pdf">scanned pdf here</a></p></li>
<li><p>Burden &amp; Faires Section 5.5</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="List-of-Problems">
<h2>List of Problems<a class="headerlink" href="#List-of-Problems" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="#prob_constant">Problem Constant</a>: Daisyworld with a constant growth rate</p>
<p><a class="reference external" href="#prob_coupling">Problem Coupling</a>: Daisyworld of neutral daisies coupled to the temperature</p>
<p><a class="reference external" href="#prob_conduction">Problem Conduction</a>: Daisyworld steady states and the effect of the conduction parameter R</p>
<p><a class="reference external" href="#prob_initial">Problem Initial</a>: Daisyworld steady states and initial conditions</p>
<p><a class="reference external" href="#prob_temperature">Problem Temperature</a>: Add temperature retrieval code</p>
<p><a class="reference external" href="#prob_estimate">Problem Estimate</a>: Compare the error estimate to the true error</p>
<p><a class="reference external" href="#prob_tolerances">Problem tolerances</a> User specified error tolerances in stepsize control</p>
<p><a class="reference external" href="#prob_adaptive">Problem Adaptive</a>: Adaptive Timestep Code</p>
<p><a class="reference external" href="#prob_predator">Problem Predators</a>: Adding predators to Daisyworld</p>
</div>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p>It is obvious that life on earth is highly sensitive to the planet’s atmospheric and climatic conditions. What is less obvious, but of great interest, is the role biology plays in the sensitivity of the climate. This is dramatically illustrated by the concern over the possible contribution to global warming by the loss of the rain forests in Brazil.</p>
<p>The fact that each may affect the other implies that the climate and life on earth are interlocked in a complex series of feedbacks, i.e. the climate affects the biosphere which, when altered, then changes the climate and so on. A fascinating question arises as to whether or not this would eventually lead to a stable climate. This scenerio is exploited to its fullest in the <em>Gaia</em> hypothesis which postulates that the biosphere, atmosphere, ocean and land are all part of some totality, dubbed
<em>Gaia</em>, which is essentially an elaborate feedback system which optimizes the conditions of life here on earth.</p>
<p>It would be hopeless to attempt to mathematically model such a large, complex system. What can be done instead is to construct a ’toy model’ of the system in which much of the complexity has been stripped away and only some of the relevant characteristics retained. The resulting system will then be tractable but, unfortunately, may bear little connection with the original physical system.</p>
<p>Daisyworld is such a model. Life on Daisyworld has been reduced to just two species of daisies of different colors. The only environmental condition that affects the daisy growth rate is temperature. The temperature in turn is modified by the varying amounts of radiation absorbed by the daisies.</p>
<p>Daisyworld is obviously a gross simplification of the real earth. However, it does retain the central feature of interest: a feedback loop between the climate and life on the planet. Since the equations governing the system will be correspondingly simplified, it will allow us to investigate under what conditions, if any, that equilibrium is reached. The hope is that this will then gain us some insight into how life on the real earth may lead to a stable climate.</p>
</div>
<div class="section" id="The-Daisyworld-Model">
<h2>The Daisyworld Model<a class="headerlink" href="#The-Daisyworld-Model" title="Permalink to this headline">¶</a></h2>
<p>Daisyworld is populated by two types of daisies, one darker and the other lighter than the bare ground. As with life on earth, the daisies will not grow at extreme temperatures and will have optimum growth at moderate temperatures.</p>
<p>The darker, ’black’ daisies absorb more radiation than the lighter, ’white’ daisies. If the black daisy population grows and spreads over more area, an increased amount of solar energy will be absorbed, which will ultimately raise the temperature of the planet. Conversely, an increase in the white daisy population will result in more radiation being reflected away, lowering the planet’s temperature.</p>
<p>The question to be answered is:</p>
<p><strong>Under what conditions, if any, will the daisy population and temperature reach equilibrium?</strong></p>
<div class="section" id="The-Daisy-Population">
<h3>The Daisy Population<a class="headerlink" href="#The-Daisy-Population" title="Permalink to this headline">¶</a></h3>
<p>The daisy population will be modeled along the lines of standard population ecology models where the net growth depends upon the current population. For example, the simplest model assumes the rate of growth is proportional to the population, i.e.</p>
<!-- \label{lab5:eq:exp} --><div class="math notranslate nohighlight">
\[\frac{dA_w}{dt} = k_w A_w\]</div>
<div class="math notranslate nohighlight">
\[\frac{dA_b}{dt} = k_b A_b\]</div>
<p>where <span class="math notranslate nohighlight">\(A_w\)</span> and <span class="math notranslate nohighlight">\(A_b\)</span> are fractions of the total planetary area covered by the white and black daisies, respectively, and <span class="math notranslate nohighlight">\(k_i\)</span>, <span class="math notranslate nohighlight">\(i=w,b\)</span>, are the white and black daisy growth rates per unit time, respectively. If assume the the growth rates <span class="math notranslate nohighlight">\(k_i\)</span> are (positive) constants we would have exponential growth like the bunny rabbits of lore.</p>
<p>We can make the model more realistic by letting the daisy birthrate depend on the amount of available land, i.e.</p>
<div class="math notranslate nohighlight">
\[k_i = \beta_i x\]</div>
<p>where <span class="math notranslate nohighlight">\(\beta_i\)</span> are the white and black daisy growth rates per unit time and area, respectively, and <span class="math notranslate nohighlight">\(x\)</span> is the fractional area of free fertile ground not colonized by either species. We can also add a daisy death rate per unit time, <span class="math notranslate nohighlight">\(\chi\)</span>, to get</p>
<div class="math notranslate nohighlight">
\[\frac{dA_w}{dt} = A_w ( \beta_w x - \chi)\]</div>
<div class="math notranslate nohighlight">
\[\frac{dA_b}{dt} = A_b ( \beta_b x - \chi)\]</div>
<p>However, even these small modifications are non-trivial mathematically as the available fertile land is given by,</p>
<div class="math notranslate nohighlight">
\[x = 1 - A_w - A_b\]</div>
<p>(assuming all the land mass is fertile) which makes the equations non-linear.</p>
<div id="prob_constant"><p><strong>Problem constant growth</strong></p>
</div><p>Note that though the daisy growth rate per unit time depends on the amount of available fertile land, it is not otherwise coupled to the environment (i.e. <span class="math notranslate nohighlight">\(\beta_i\)</span> is note a function of temperature. Making the growth a function of bare ground, however, keeps the daisy population bounded and the daisy population will eventually reach some steady state. The next python cell has a script that runs a fixed timestep Runge Kutte routine that calculates area coverage of white and black daisies
for fixed growth rates <span class="math notranslate nohighlight">\(\beta_w\)</span> and <span class="math notranslate nohighlight">\(\beta_b\)</span>. Try changing these growth rates (specified in the derivs5 routine) and the initial white and black concentrations (specified in the fixed_growth.yaml file discussed next).</p>
<ol class="arabic simple">
<li><p>For a given set of growth rates try various (non-zero) initial daisy populations.</p></li>
<li><p>For a given set of initial conditions try various growth rates. In particular, try rates that are both greater than and less than the death rate.</p></li>
<li><p>Can you determine when non-zero steady states are achieved? Explain.</p></li>
</ol>
</div>
<div class="section" id="Running-the-constant-growth-rate-demo">
<h3>Running the constant growth rate demo<a class="headerlink" href="#Running-the-constant-growth-rate-demo" title="Permalink to this headline">¶</a></h3>
<p>In the appendix we discuss the design of the integrator class and the adaptive Runge-Kutta routine. For this demo, we need to be able to change variables in the configuration file. For this demonstration you are asked to</p>
<ol class="arabic">
<li><p>Change the inital white and black daisy concentrations by changing these lines in the <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/notebooks/lab5/fixed_growth.yaml#L13-L15">fixed_growth.yaml</a> input file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">initvars</span><span class="p">:</span>
   <span class="nt">whiteconc</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.2</span>
   <span class="nt">blackconc</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.7</span>
</pre></div>
</div>
</li>
<li><p>Change the white and black daisy growth rates by editing the variables beta_w and beta_b in the derivs5 routine in the next cell</p></li>
</ol>
<p>The Integrator class contains two different timeloops, both of which use embedded Runge Kutta Cash Carp code given in Lab 4 and code here as <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L70">rkckODE5</a>. The simplest way to loop through the timesteps is just to call the integrator with a specified set of times. This is done in
<a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L244">timeloop5fixed</a>. Below we will describe how to use the error extimates returned by rkckODE5 to tune the size of the timesteps, which is done in <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L244">timeloop5Err</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># 4.1  integrate constant growth rates with fixed timesteps</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">context</span>
<span class="kn">from</span> <span class="nn">numlabs.lab5.lab5_funs</span> <span class="kn">import</span> <span class="n">Integrator</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="k">class</span> <span class="nc">Integ51</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">set_yinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;albedo_white chi S0 L albedo_black R albedo_ground&#39;</span>
        <span class="c1">#</span>
        <span class="n">uservars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;uservars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span> <span class="o">=</span> <span class="n">uservars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;whiteconc blackconc&#39;</span>
        <span class="c1">#</span>
        <span class="n">initvars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;initvars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initvars</span> <span class="o">=</span> <span class="n">initvars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initvars</span><span class="o">.</span><span class="n">whiteconc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initvars</span><span class="o">.</span><span class="n">blackconc</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yinit</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">#</span>
    <span class="c1"># Construct an Integ51 class by inheriting first intializing</span>
    <span class="c1"># the parent Integrator class (called super).  Then do the extra</span>
    <span class="c1"># initialization in the set_yint function</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeffFileName</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coeffFileName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_yinit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">derivs5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;y[0]=fraction white daisies</span>
<span class="sd">           y[1]=fraction black daisies</span>

<span class="sd">           Constant growty rates for white</span>
<span class="sd">           and black daisies beta_w and beta_b</span>

<span class="sd">           returns dy/dt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span>
        <span class="c1">#</span>
        <span class="c1"># bare ground</span>
        <span class="c1">#</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># growth rates don&#39;t depend on temperature</span>
        <span class="n">beta_b</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># growth rate for black daisies</span>
        <span class="n">beta_w</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># growth rate for white daisies</span>

        <span class="c1"># create a 1 x 2 element vector to hold the derivitive</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">],</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_w</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">chi</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">chi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>


<span class="n">theSolver</span> <span class="o">=</span> <span class="n">Integ51</span><span class="p">(</span><span class="s1">&#39;fixed_growth.yaml&#39;</span><span class="p">)</span>
<span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="n">errorList</span> <span class="o">=</span> <span class="n">theSolver</span><span class="o">.</span><span class="n">timeloop5fixed</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">theLines</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5 interactive 1  constant growth rate&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fractional coverage&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">theLines</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;white daisies&#39;</span><span class="p">,</span> <span class="s1">&#39;black daisies&#39;</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">theLines</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">errorList</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5 interactive 1 errors&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">theLines</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;white errors&#39;</span><span class="p">,</span> <span class="s1">&#39;black errors&#39;</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
******************************
context imported. Front of path:
/Users/phil/repos/numeric
back of path: /Users/phil/.ipython
******************************

through /Users/phil/repos/numeric/notebooks/lab5/context.py
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_9_1.png" src="../../_images/doc_notebooks_lab5_01-lab5_9_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_9_2.png" src="../../_images/doc_notebooks_lab5_01-lab5_9_2.png" />
</div>
</div>
</div>
<div class="section" id="The-Daisy-Growth-Rate---Coupling-to-the-Environment">
<h3>The Daisy Growth Rate - Coupling to the Environment<a class="headerlink" href="#The-Daisy-Growth-Rate---Coupling-to-the-Environment" title="Permalink to this headline">¶</a></h3>
<p>We now want to couple the Daisy growth rate to the climate, which we do by making the growth rate a function of the local temperature <span class="math notranslate nohighlight">\(T_i\)</span>,</p>
<div class="math notranslate nohighlight">
\[\beta_i = \beta_i(T_i)\]</div>
<p>The growth rate should drop to zero at extreme temperatures and be optimal at moderate temperatures. In Daisyworld this means the daisy population ceases to grow if the temperature drops below <span class="math notranslate nohighlight">\(5^o\)</span>C or goes above $40^o $C. The simplest model for the growth rate would then be parabolic function of temperature, lpeaking at <span class="math notranslate nohighlight">\(22.5^o\)</span>C:</p>
<!-- \label{lab5:eq:beta_i} --><div class="math notranslate nohighlight">
\[\beta_i = 1.0 - 0.003265(295.5 K - T_i)^2\]</div>
<p>where the <span class="math notranslate nohighlight">\(i\)</span> subscript denotes the type of daisy: grey (i=y), whithe (i=w) or black (i=b). (We’re reserving <span class="math notranslate nohighlight">\(\alpha_g\)</span> for the bare ground albedo)</p>
<p>Before specifying the local temperature, and its dependence on the daisy population, first consider the emission temperature <span class="math notranslate nohighlight">\(T_e\)</span>, which is the mean temperature of the planet,</p>
<!-- \label{lab5:eq:tempe} --><div class="math notranslate nohighlight">
\[T^4_e = L \frac{S_0}{4\sigma}(1-\alpha_p)\]</div>
<p>where <span class="math notranslate nohighlight">\(S_0\)</span> is a solar flux density constant, <span class="math notranslate nohighlight">\(L\)</span> is the fraction of <span class="math notranslate nohighlight">\(S_0\)</span> received at Daisyworld, and <span class="math notranslate nohighlight">\(\alpha_p\)</span> is the planetary albedo. The greater the planetary albedo <span class="math notranslate nohighlight">\(\alpha_p\)</span>, i.e. the more solar radiation the planet reflects, the lower the emission temperature.</p>
<p><strong>Mathematical note</strong>: The emission temperature is derived on the assumption that the planet is in global energy balance and is behaving as a blackbody radiator. See the appendix for more information.</p>
<div id="prob_coupling"><p><strong>Problem coupling</strong></p>
</div><p>Consider daisies with the same albedo as the planet, i.e. ’grey’ or neutral daisies, as specified in derivs5 routine below.</p>
<ol class="arabic">
<li><p>For the current value of L (0.2) in the file coupling.yaml, the final daisy steady state is zero. Why is it zero?</p></li>
<li><p>Find a value of L which leads to a non-zero steady state.</p></li>
<li><p>What happens to the emission temperature as L is varied? Make a plot of <span class="math notranslate nohighlight">\(L\)</span> vs. <span class="math notranslate nohighlight">\(T_E\)</span> for 10-15 values of <span class="math notranslate nohighlight">\(L\)</span>. To do this, I overrode the value of L from the init file by passing a new value into the IntegCoupling constructor (see <a class="reference external" href="#sec_override">Appendix A</a>). This allowed me to put</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">theSolver</span> <span class="o">=</span> <span class="n">IntegCoupling</span><span class="p">(</span><span class="s2">&quot;coupling.yaml&quot;</span><span class="p">,</span><span class="n">newL</span><span class="p">)</span>
<span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="n">errorList</span> <span class="o">=</span> <span class="n">theSolver</span><span class="o">.</span><span class="n">timeloop5fixed</span><span class="p">()</span>
</pre></div>
</div>
<p>inside a loop that varied the L value and saved the steady state concentration for plotting</p>
</li>
</ol>
<p>After reading the the next section on the local temperature,</p>
<ol class="arabic simple" start="4">
<li><p>Do you see any difference between the daisy temperature and emission temperature? Plot both and explain. (Hint: I modified derivs5 to save these variables to self so I could compare their values at the end of the simulation. You could also override timeloop5fixed to do the same thing at each timestep.)</p></li>
<li><p>How (i.e. thorugh what mechanism) does the makeup of the global daisy population affect the local temperature?</p></li>
</ol>
<p>Hand in – notebook cells with the code, plots and your answers.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="k">class</span> <span class="nc">IntegCoupling</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;rewrite the init and derivs5 methods to</span>
<span class="sd">       work with a single (grey) daisy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">set_yinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;albedo_grey chi S0 L  R albedo_ground&#39;</span>
        <span class="c1">#</span>
        <span class="n">uservars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;uservars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span> <span class="o">=</span> <span class="n">uservars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;greyconc&#39;</span>
        <span class="c1">#</span>
        <span class="n">initvars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;initvars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initvars</span> <span class="o">=</span> <span class="n">initvars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">initvars</span><span class="o">.</span><span class="n">greyconc</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yinit</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeffFileName</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coeffFileName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_yinit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">derivs5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           Make the growth rate depend on the ground temperature</span>
<span class="sd">           using the quadratic function of temperature</span>

<span class="sd">           y[0]=fraction grey daisies</span>
<span class="sd">           t = time</span>
<span class="sd">           returns f[0] = dy/dt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">5.67e-8</span>  <span class="c1"># Stefan Boltzman constant W/m^2/K^4</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">albedo_p</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_ground</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_grey</span>
        <span class="n">Te_4</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">S0</span> <span class="o">/</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">albedo_p</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">S0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">temp_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">albedo_p</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_grey</span><span class="p">)</span> <span class="o">+</span> <span class="n">Te_4</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">temp_y</span> <span class="o">&gt;=</span> <span class="mf">277.5</span> <span class="ow">and</span> <span class="n">temp_y</span> <span class="o">&lt;=</span> <span class="mf">312.5</span><span class="p">):</span>
            <span class="n">beta_y</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.003265</span> <span class="o">*</span> <span class="p">(</span><span class="mf">295.0</span> <span class="o">-</span> <span class="n">temp_y</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_y</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># create a 1 x 1 element vector to hold the derivative</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_y</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">chi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">theSolver</span> <span class="o">=</span> <span class="n">IntegCoupling</span><span class="p">(</span><span class="s1">&#39;coupling.yaml&#39;</span><span class="p">)</span>
<span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="n">errorList</span> <span class="o">=</span> <span class="n">theSolver</span><span class="o">.</span><span class="n">timeloop5fixed</span><span class="p">()</span>

<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">theLines</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5: interactive 2 Coupling with grey daisies&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fractional coverage&#39;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">theLines</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;grey daisies&#39;</span><span class="p">,</span> <span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_15_0.png" src="../../_images/doc_notebooks_lab5_01-lab5_15_0.png" />
</div>
</div>
</div>
<div class="section" id="The-Local-Temperature---Dependence-on-Surface-Heat-Conductivity">
<h3>The Local Temperature - Dependence on Surface Heat Conductivity<a class="headerlink" href="#The-Local-Temperature---Dependence-on-Surface-Heat-Conductivity" title="Permalink to this headline">¶</a></h3>
<p>If we now allow for black and white daisies, the local temperature will differ according to the albedo of the region. The regions with white daisies will tend to be cooler than the ground and the regions with black daisies will tend to be hotter. To determine what the temperature is locally, we need to decide how readily the planet surface thermalises, i.e. how easily large-scale weather patterns redistributes the surface heat.</p>
<ul>
<li><p>If there is perfect heat ‘conduction’ between the different regions of the planet then the local temperature will equal the mean temperature given by the emission temperature <span class="math notranslate nohighlight">\(T_e\)</span>.</p>
<!-- \label{lab5:eq:temp0} --><div class="math notranslate nohighlight">
\[T^4_i \equiv T^4_e = L \frac{S_0}{4\sigma}(1-\alpha_p)\]</div>
</li>
<li><p>If there is no conduction, or perfect ‘insulation’, between regions then the temperature will be the emission temperature due to the albedo of the local region.</p>
<!-- \label{lab5:eq:temp1} --><div class="math notranslate nohighlight">
\[T^4_i= L \frac{S_0}{4\sigma}(1-\alpha_i)\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha_i\)</span> indicates either <span class="math notranslate nohighlight">\(\alpha_g\)</span>, <span class="math notranslate nohighlight">\(\alpha_w\)</span> or <span class="math notranslate nohighlight">\(\alpha_b\)</span>.</p>
</li>
</ul>
<p>The local temperature can be chosen to lie between these two values,</p>
<!-- \label{lab5:eq:tempi} --><div class="math notranslate nohighlight">
\[T^4_i = R L \frac{S_0}{4\sigma}(\alpha_p-\alpha_i) + T^4_e\]</div>
<p>where <span class="math notranslate nohighlight">\(R\)</span> is a parameter that interpolates between the two extreme cases i.e. <span class="math notranslate nohighlight">\(R=0\)</span> means perfect conduction and <span class="math notranslate nohighlight">\(R=1\)</span> implies perfect insulation between regions.</p>
<div id="prob_conduction"><p><strong>Problem conduction</strong></p>
</div><p>The conduction parameter R will determine the temperature differential between the bare ground and the regions with black or white daisies. The code in the next cell specifies the derivatives for this situation, removing the feedback between the daisies and the planetary albedo but introducint conduction. Use it to investigate these two questions:</p>
<ol class="arabic simple">
<li><p>Change the value of R and observe the effects on the daisy and emission temperature.</p></li>
<li><p>What are the effects on the daisy growth rate and the final steady states?</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># 5.2  keep the albedo constant at alpha_p and vary the conductivity R</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">numlabs.lab5.lab5_funs</span> <span class="kn">import</span> <span class="n">Integrator</span>


<span class="k">class</span> <span class="nc">Integ53</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">set_yinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;albedo_white chi S0 L albedo_black R albedo_ground&#39;</span>
        <span class="c1">#</span>
        <span class="n">uservars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;uservars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span> <span class="o">=</span> <span class="n">uservars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;whiteconc blackconc&#39;</span>
        <span class="c1">#</span>
        <span class="n">initvars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;initvars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initvars</span> <span class="o">=</span> <span class="n">initvars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initvars</span><span class="o">.</span><span class="n">whiteconc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initvars</span><span class="o">.</span><span class="n">blackconc</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yinit</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeffFileName</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coeffFileName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_yinit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">derivs5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;y[0]=fraction white daisies</span>
<span class="sd">           y[1]=fraction black daisies</span>
<span class="sd">           no feedback between daisies and</span>
<span class="sd">           albedo_p (set to ground albedo)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">5.67e-8</span>  <span class="c1"># Stefan Boltzman constant W/m^2/K^4</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1"># hard wire the albedo to that of the ground -- no daisy feedback</span>
        <span class="c1">#</span>
        <span class="n">albedo_p</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_ground</span>
        <span class="n">Te_4</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">S0</span> <span class="o">/</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">albedo_p</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">S0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">temp_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">albedo_p</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_black</span><span class="p">)</span> <span class="o">+</span> <span class="n">Te_4</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span>
        <span class="n">temp_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">albedo_p</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_white</span><span class="p">)</span> <span class="o">+</span> <span class="n">Te_4</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">temp_b</span> <span class="o">&gt;=</span> <span class="mf">277.5</span> <span class="ow">and</span> <span class="n">temp_b</span> <span class="o">&lt;=</span> <span class="mf">312.5</span><span class="p">):</span>
            <span class="n">beta_b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.003265</span> <span class="o">*</span> <span class="p">(</span><span class="mf">295.0</span> <span class="o">-</span> <span class="n">temp_b</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_b</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">temp_w</span> <span class="o">&gt;=</span> <span class="mf">277.5</span> <span class="ow">and</span> <span class="n">temp_w</span> <span class="o">&lt;=</span> <span class="mf">312.5</span><span class="p">):</span>
            <span class="n">beta_w</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.003265</span> <span class="o">*</span> <span class="p">(</span><span class="mf">295.0</span> <span class="o">-</span> <span class="n">temp_w</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_w</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># create a 1 x 2 element vector to hold the derivitive</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">],</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_w</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">chi</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">chi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">theSolver</span> <span class="o">=</span> <span class="n">Integ53</span><span class="p">(</span><span class="s1">&#39;conduction.yaml&#39;</span><span class="p">)</span>
<span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="n">errorList</span> <span class="o">=</span> <span class="n">theSolver</span><span class="o">.</span><span class="n">timeloop5fixed</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">theLines</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">theLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5 interactive 3 -- conduction problem&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fractional coverage&#39;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">theLines</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;white daisies&#39;</span><span class="p">,</span> <span class="s1">&#39;black daisies&#39;</span><span class="p">),</span>
                   <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_18_0.png" src="../../_images/doc_notebooks_lab5_01-lab5_18_0.png" />
</div>
</div>
</div>
<div class="section" id="The-Feedback-Loop---Feedback-Through-the-Planetary-Albedo">
<h3>The Feedback Loop - Feedback Through the Planetary Albedo<a class="headerlink" href="#The-Feedback-Loop---Feedback-Through-the-Planetary-Albedo" title="Permalink to this headline">¶</a></h3>
<p>The amount of solar radiation the planet reflects will depend on the daisy population since the white daisies will reflect more radiation than the bare ground and the black daisies will reflect less. So a reasonable estimate of the planetary albedo <span class="math notranslate nohighlight">\(\alpha_p\)</span> is an average of the albedo’s of the white and black daisies and the bare ground, weighted by the amount of area covered by each, i.e.</p>
<!-- \label{lab5:eq:albedop} --><div class="math notranslate nohighlight">
\[\alpha_p = A_w\alpha_w + A_b\alpha_b + A_g\alpha_g\]</div>
<p>A greater population of white daisies will tend to increase planetary albedo and decrease the emission temperature, as is apparent from equation ([lab5:eq:tempe]), while the reverse is true for the black daisies.</p>
<p>To summarize: The daisy population is controlled by its growth rate <span class="math notranslate nohighlight">\(\beta_i\)</span> which is a function of the local temperature <span class="math notranslate nohighlight">\(T_i\)</span></p>
<div class="math notranslate nohighlight">
\[\beta_i = 1.0 - 0.003265(295.5 K -T_i)^2\]</div>
<p>If the conductivity <span class="math notranslate nohighlight">\(R\)</span> is nonzero, the local temperature is a function of planetary albedo <span class="math notranslate nohighlight">\(\alpha_p\)</span></p>
<div class="math notranslate nohighlight">
\[T_i = \left[ R L \frac{S_0}{4\sigma}(\alpha_p-\alpha_i)
  + T^4_e \right]^{\frac{1}{4}}\]</div>
<p>which is determined by the daisy population.</p>
<ul class="simple">
<li><p>Physically, this provides the feedback from the daisy population back to the temperature, completing the loop between the daisies and temperature.</p></li>
<li><p>Mathematically, this introduces a rather nasty non-linearity into the equations which, as pointed out in the lab 1, usually makes it difficult, if not impossible, to obtain exact analytic solutions.</p></li>
</ul>
<div id="prob_initial"><p><strong>Problem initial</strong></p>
</div><p>The feedback means a stable daisy population (a steady state) and the environmental conditions are in a delicate balance. The code below produces a steady state which arises from a given initial daisy population,</p>
<ol class="arabic simple">
<li><p>Add a small initial fraction of black daisies (say, 0.01) to the value in initial.yaml and see what effect this has on the temperature and final daisy populations. Do you still have a final non-zero daisy population?</p></li>
<li><p>Attempt to adjust the initial white daisy population to obtain a non-zero steady state. Do you have to increase or decrease the initial fraction? What is your explanation for this behavior?</p></li>
<li><p>Experiment with other initial fractions of daisies and look for non-zero steady states.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">numlabs.lab5.lab5_funs</span> <span class="kn">import</span> <span class="n">Integrator</span>


<span class="k">class</span> <span class="nc">Integ54</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">set_yinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;albedo_white chi S0 L albedo_black R albedo_ground&#39;</span>
        <span class="c1">#</span>
        <span class="n">uservars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;uservars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span> <span class="o">=</span> <span class="n">uservars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;whiteconc blackconc&#39;</span>
        <span class="c1">#</span>
        <span class="n">initvars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;initvars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initvars</span> <span class="o">=</span> <span class="n">initvars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initvars</span><span class="o">.</span><span class="n">whiteconc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initvars</span><span class="o">.</span><span class="n">blackconc</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yinit</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff_file_name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coeff_file_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_yinit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">find_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yvals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the temperatures over the white and black daisies</span>
<span class="sd">            and the planetary equilibrium temperature given the daisy fractions</span>

<span class="sd">            input:  yvals -- array of dimension [2] with the white [0] and black [1]</span>
<span class="sd">                    daisy fractiion</span>
<span class="sd">            output:  white temperature (K), black temperature (K), equilibrium temperature (K)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">5.67e-8</span>  <span class="c1"># Stefan Boltzman constant W/m^2/K^4</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span>
        <span class="n">bare</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">yvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">albedo_p</span> <span class="o">=</span> <span class="n">bare</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_ground</span> <span class="o">+</span> \
            <span class="n">yvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_white</span> <span class="o">+</span> <span class="n">yvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_black</span>
        <span class="n">Te_4</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">S0</span> <span class="o">/</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">albedo_p</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
        <span class="n">temp_e</span> <span class="o">=</span> <span class="n">Te_4</span><span class="o">**</span><span class="mf">0.25</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">user</span><span class="o">.</span><span class="n">S0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">temp_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">albedo_p</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_black</span><span class="p">)</span> <span class="o">+</span> <span class="n">Te_4</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span>
        <span class="n">temp_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">albedo_p</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">albedo_white</span><span class="p">)</span> <span class="o">+</span> <span class="n">Te_4</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">temp_w</span><span class="p">,</span> <span class="n">temp_b</span><span class="p">,</span> <span class="n">temp_e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">derivs5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;y[0]=fraction white daisies</span>
<span class="sd">           y[1]=fraction black daisies</span>
<span class="sd">           no feedback between daisies and</span>
<span class="sd">           albedo_p (set to ground albedo)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp_w</span><span class="p">,</span> <span class="n">temp_b</span><span class="p">,</span> <span class="n">temp_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_temp</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">temp_b</span> <span class="o">&gt;=</span> <span class="mf">277.5</span> <span class="ow">and</span> <span class="n">temp_b</span> <span class="o">&lt;=</span> <span class="mf">312.5</span><span class="p">):</span>
            <span class="n">beta_b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.003265</span> <span class="o">*</span> <span class="p">(</span><span class="mf">295.0</span> <span class="o">-</span> <span class="n">temp_b</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_b</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">temp_w</span> <span class="o">&gt;=</span> <span class="mf">277.5</span> <span class="ow">and</span> <span class="n">temp_w</span> <span class="o">&lt;=</span> <span class="mf">312.5</span><span class="p">):</span>
            <span class="n">beta_w</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.003265</span> <span class="o">*</span> <span class="p">(</span><span class="mf">295.0</span> <span class="o">-</span> <span class="n">temp_w</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_w</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span>
        <span class="n">bare</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># create a 1 x 2 element vector to hold the derivitive</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_w</span> <span class="o">*</span> <span class="n">bare</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">chi</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_b</span> <span class="o">*</span> <span class="n">bare</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">chi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">theSolver</span> <span class="o">=</span> <span class="n">Integ54</span><span class="p">(</span><span class="s1">&#39;initial.yaml&#39;</span><span class="p">)</span>
<span class="n">timevals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">errorlist</span> <span class="o">=</span> <span class="n">theSolver</span><span class="o">.</span><span class="n">timeloop5fixed</span><span class="p">()</span>
<span class="n">daisies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">yvals</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">])</span>

<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">line1</span><span class="p">,</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timevals</span><span class="p">,</span> <span class="n">daisies</span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">])</span>
<span class="n">line2</span><span class="p">,</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timevals</span><span class="p">,</span> <span class="n">daisies</span><span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">])</span>
<span class="n">line1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">line2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5 interactive 4, initial conditions&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fractional coverage&#39;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_22_0.png" src="../../_images/doc_notebooks_lab5_01-lab5_22_0.png" />
</div>
</div>
<div id="prob_temperature"><p><strong>Problem temperature</strong></p>
</div><p>The code above adds a new method, <code class="docutils literal notranslate"><span class="pre">find_temp</span></code> that takes the white/black daisy fractions and calculates local and planetary temperatures.</p>
<ol class="arabic simple">
<li><p>override <code class="docutils literal notranslate"><span class="pre">timeloop5fixed</span></code> so that it saves these three temperatures, plus the daisy growth rates to new variables in the Integ54 instance</p></li>
<li><p>Make plots of (temp_w, temp_b) and (beta_w, beta_b) vs. time for a case with non-zero equilibrium concentrations of both black and white daisies</p></li>
</ol>
</div>
</div>
<div class="section" id="Adaptive-Stepsize-in-Runge-Kutta">
<h2>Adaptive Stepsize in Runge-Kutta<a class="headerlink" href="#Adaptive-Stepsize-in-Runge-Kutta" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Why-Adaptive-Stepsize?">
<h3>Why Adaptive Stepsize?<a class="headerlink" href="#Why-Adaptive-Stepsize?" title="Permalink to this headline">¶</a></h3>
<p>As a rule of thumb, accuracy increases in Runge-Kutta methods as stepsize decreases. At the same time, the number of function evaluations performed increases. This tradeoff between accuracy of the solution and computational cost always exists, but in the ODE solution algorithms presented earlier it often appears to be unnecessarily large. To see this, consider the solution to a problem in two different time intervals. In the first one, the solution is close to steady, whereas in the second one
it changes quickly. For acceptable accuracy with a non-adaptive method the step size will have to be adjusted so that the approximate solution is close to the actual solution in the second interval. The stepsize will be fairly small, so that the approximate solution is able to follow the changes in the solution here. However, as there is no change in stepsize throughout the solution process, the same step size will be applied to approximate the solution in the first time interval, where clearly
a much larger stepsize would suffice to achieve the same accuracy. Thus, in a region where the solution behaves nicely a lot of function evaluations are wasted because the stepsize is chosen in accordance with the most quickly changing part of the solution.</p>
<p>The way to address this problem is the use of adaptive stepsize control. This class of algorithms adjusts the stepsize taken in a time interval according to the properties of the solution in that interval, making it useful for producing a solution that has a given accuracy in the minimum number of steps.</p>
</div>
<div class="section" id="Designing-Adaptive-Stepsize-Control">
<h3>Designing Adaptive Stepsize Control<a class="headerlink" href="#Designing-Adaptive-Stepsize-Control" title="Permalink to this headline">¶</a></h3>
<p>Now that the goal is clear, the question remains of how to close in on it. As mentioned above, an adaptive algorithm is usually asked to solve a problem to a desired accuracy. To be able to adjust the stepsize in Runge-Kutta the algorithm must therefore calculate some estimate of how far its solution deviates from the actual solution. If with its initial stepsize this estimate is already well within the desired accuracy, the algorithm can proceed with a larger stepsize. If the error estimate is
larger than the desired accuracy, the algorithm decreases the stepsize at this point and attempts to take a smaller step. Calculating this error estimate will always increase the amount of work done at a step compared to non-adaptive methods. Thus, the remaining problem is to devise a method of calculating this error estimate that is both inexpensive and accurate.</p>
</div>
<div class="section" id="Error-Estimate-by-Step-Doubling">
<h3>Error Estimate by Step Doubling<a class="headerlink" href="#Error-Estimate-by-Step-Doubling" title="Permalink to this headline">¶</a></h3>
<p>The first and simple approach to arriving at an error estimate is to simply take every step twice. The second time the step is divided up into two steps, producing a different estimate of the solution. The difference in the two solutions can be used to produce an estimate of the truncation error for this step.</p>
<p>How expensive is this method to estimate the error? A single step of fourth order Runge-Kutta always takes four function evaluations. As the second time the step is taken in half-steps, it will take 8 evaluations. However, the first function evaluation in taking a step twice is identical to both steps, and thus the overall cost for one step with step doubling is <span class="math notranslate nohighlight">\(12 - 1 = 11\)</span> function evaluations. This should be compared to taking two normal half-steps as this corresponds to the overall
accuracy achieved. So we are looking at 3 function evaluations more per step, or an increase of computational cost by a factor of <span class="math notranslate nohighlight">\(1.375\)</span>.</p>
<p>Step doubling works in practice, but the next section presents a slicker way of arriving at an error estimate that is less computationally expensive. It is the commmonly used one today.</p>
</div>
<div class="section" id="Error-Estimate-using-Embedded-Runge-Kutta">
<h3>Error Estimate using Embedded Runge-Kutta<a class="headerlink" href="#Error-Estimate-using-Embedded-Runge-Kutta" title="Permalink to this headline">¶</a></h3>
<p>Another way of estimating the truncation error of a step is due to the existence of the special fifth-order Runge-Kutta methods discussed earlier. These methods use six function evaluations which can be recombined to produce a fourth-order method . Again, the difference between the fifth and the fourth order solution is used to calculate an estimate of the truncation error. Obviously this method requires fewer function evaluations than step doubling, as the two estimates use the same evaluation
points. Originally this method was found by Fehlberg, and later Cash and Karp produced the set of constants presented earlier that produce an efficient and accurate error estimate.</p>
<div id="prob_estimate"><p><strong>Problem Estimate</strong></p>
</div><p>In the demo below, compare the error estimate to the true error, on the initial value problem from ,</p>
<div class="math notranslate nohighlight">
\[\frac{dy}{dt} = -y +t +1,  \;\;\;\; y(0) =1\]</div>
<p>which has the exact solution</p>
<div class="math notranslate nohighlight">
\[y(t) = t + e^{-t}\]</div>
<ol class="arabic simple">
<li><p>Play with the time step and final time, attempting small changes at first. How reasonable is the error estimate?</p></li>
<li><p>Keep decreasing the time step. Does the error estimate diverge from the computed error? Why?</p></li>
<li><p>Keep increasing the time step. Does the error estimate diverge? What is happening with the numerical solution?</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">numlabs.lab5.lab5_funs</span> <span class="kn">import</span> <span class="n">Integrator</span>


<span class="k">class</span> <span class="nc">Integ55</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">set_yinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># read in &#39;c1 c2 c3&#39;</span>
        <span class="c1">#</span>
        <span class="n">uservars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;uservars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span> <span class="o">=</span> <span class="n">uservars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;uservars&#39;</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="c1"># read in initial yinit</span>
        <span class="c1">#</span>
        <span class="n">initvars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;initvars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initvars</span> <span class="o">=</span> <span class="n">initvars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">initvars</span><span class="o">.</span><span class="n">yinit</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yinit</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff_file_name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coeff_file_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_yinit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">derivs5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">theTime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           y[0]=fraction white daisies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uservars</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yinit</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">c1</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">c2</span> <span class="o">*</span> <span class="n">theTime</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">c3</span>
        <span class="k">return</span> <span class="n">f</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">theSolver</span> <span class="o">=</span> <span class="n">Integ55</span><span class="p">(</span><span class="s1">&#39;expon.yaml&#39;</span><span class="p">)</span>

<span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="n">yErrors</span> <span class="o">=</span> <span class="n">theSolver</span><span class="o">.</span><span class="n">timeloop5Err</span><span class="p">()</span>
<span class="n">timeVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeVals</span><span class="p">)</span>
<span class="n">exact</span> <span class="o">=</span> <span class="n">timeVals</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">timeVals</span><span class="p">)</span>
<span class="n">yVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yVals</span><span class="p">)</span>
<span class="n">yVals</span> <span class="o">=</span> <span class="n">yVals</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">yErrors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yErrors</span><span class="p">)</span>

<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">line1</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;adapt&#39;</span><span class="p">)</span>
<span class="n">line2</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5 interactive 5&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y value&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># we need to unpack yvals (a list of arrays of length 1</span>
<span class="c1"># into an array of numbers using a list comprehension</span>
<span class="c1">#</span>

<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">realestError</span> <span class="o">=</span> <span class="n">yVals</span> <span class="o">-</span> <span class="n">exact</span>
<span class="n">actualErrorLine</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">realestError</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;actual error&#39;</span><span class="p">)</span>
<span class="n">estimatedErrorLine</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">yErrors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;estimated error&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

<span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="n">yErrors</span> <span class="o">=</span> <span class="n">theSolver</span><span class="o">.</span><span class="n">timeloop5fixed</span><span class="p">()</span>

<span class="n">np_yVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yVals</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">yErrors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yErrors</span><span class="p">)</span>
<span class="n">np_exact</span> <span class="o">=</span> <span class="n">timeVals</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">timeVals</span><span class="p">)</span>

<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">line1</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">np_yVals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">)</span>
<span class="n">line2</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">np_exact</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5 interactive 5 -- fixed&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y value&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">)</span>

<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">realestError</span> <span class="o">=</span> <span class="n">np_yVals</span> <span class="o">-</span> <span class="n">np_exact</span>
<span class="n">actualErrorLine</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">realestError</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;actual error&#39;</span><span class="p">)</span>
<span class="n">estimatedErrorLine</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">yErrors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;estimated error&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5 interactive 5 -- fixed errors&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;lab 5 interactive 5 -- fixed errors&#39;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_27_1.png" src="../../_images/doc_notebooks_lab5_01-lab5_27_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_27_2.png" src="../../_images/doc_notebooks_lab5_01-lab5_27_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_27_3.png" src="../../_images/doc_notebooks_lab5_01-lab5_27_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_27_4.png" src="../../_images/doc_notebooks_lab5_01-lab5_27_4.png" />
</div>
</div>
</div>
<div class="section" id="Using-Error-to-Adjust-the-Stepsize">
<h3>Using Error to Adjust the Stepsize<a class="headerlink" href="#Using-Error-to-Adjust-the-Stepsize" title="Permalink to this headline">¶</a></h3>
<p>Both step doubling and embedded methods leave us with the difference between two different order solutions to the same step. Provided is a desired accuracy, <span class="math notranslate nohighlight">\(\Delta_{des}\)</span>. The way this accuracy is specified depends on the problem. It can be relative to the solution at step <span class="math notranslate nohighlight">\(i\)</span>,</p>
<div class="math notranslate nohighlight">
\[\Delta_{des}(i) = RTOL\cdot |y(i)|\]</div>
<p>where <span class="math notranslate nohighlight">\(RTOL\)</span> is the relative tolerance desired. An absolute part should be added to this so that the desired accuracy does not become zero. There are more ways to adjust the error specification to the problem, but the overall goal of the algorithm always is to make <span class="math notranslate nohighlight">\(\Delta_{est}(i)\)</span>, the estimated error for a step, satisfy</p>
<div class="math notranslate nohighlight">
\[|\Delta_{est}(i)|\leq\Delta_{des}(i)|\]</div>
<p>Note also that for a system of ODEs <span class="math notranslate nohighlight">\(\Delta_{des}\)</span> is of course a vector, and it is wise to replace the componentwise comparison by a vector norm.</p>
<p>Note now that the calculated error term is <span class="math notranslate nohighlight">\(O(h^{5})\)</span> as it was found as an error estimate to fourth-order Runge-Kutta methods. This makes it possible to scale the stepsize as</p>
<!-- \label{lab5:eq:hnew} --><div class="math notranslate nohighlight">
\[h_{new} = h_{old}[{\Delta_{des}\over \Delta_{est}}]^{1/5}\]</div>
<p>or, to give an example of the suggested use of vector norms above, the new stepsize is given by</p>
<p><span class="math">\begin{equation}
\label{eq:hnewnorm}
h_{new} = S h_{old}\{[{1\over N}\sum_{i=1}^{N}({\Delta_{est}(i)\over
\Delta_{des}(i)})^{2}]^{1/2}\}^{-1/5}\}
\end{equation}</span></p>
<p>using the root-mean-square norm. <span class="math notranslate nohighlight">\(S\)</span> appears as a safety factor (<span class="math notranslate nohighlight">\(0&lt;S&lt;1\)</span>) to counteract the inaccuracy in the use of estimates.</p>
<p>The coefficients for the adaptive tolerances are set in adaptvars section of adapt.yaml:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">adaptvars</span><span class="p">:</span>
  <span class="nt">dtpassmin</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.1</span>
  <span class="nt">dtfailmax</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
  <span class="nt">dtfailmin</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.1</span>
  <span class="nt">s</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.9</span>
  <span class="nt">rtol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0e-05</span>
  <span class="nt">atol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0e-05</span>
  <span class="nt">maxsteps</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2000.0</span>
  <span class="nt">maxfail</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60.0</span>
  <span class="nt">dtpassmax</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5.0</span>
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">theSolver</span> <span class="o">=</span> <span class="n">Integ54</span><span class="p">(</span><span class="s1">&#39;adapt.yaml&#39;</span><span class="p">)</span>
<span class="n">timeVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="n">errorList</span> <span class="o">=</span> <span class="n">theSolver</span><span class="o">.</span><span class="n">timeloop5Err</span><span class="p">()</span>

<span class="n">yvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">yVals</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">])</span>

<span class="n">thefig</span><span class="p">,</span> <span class="n">theAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">points</span><span class="p">,</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">],</span> <span class="s1">&#39;-b+&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;white daisies&#39;</span><span class="p">)</span>
<span class="n">points</span><span class="o">.</span><span class="n">set_markersize</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">theLine1</span><span class="p">,</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">],</span> <span class="s1">&#39;--ko&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;black daisies&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;lab 5 interactive 6&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">theAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fractional coverage&#39;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">theAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

<span class="c1"># timeVals,yVals,errorList=theSolver.timeloop5fixed()</span>
<span class="c1"># whiteDaisies=[frac[0] for frac in yVals]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/doc_notebooks_lab5_01-lab5_30_0.png" src="../../_images/doc_notebooks_lab5_01-lab5_30_0.png" />
</div>
</div>
<div id="prob_tolerances"><p><strong>Problem tolerances</strong></p>
</div><p>The Runge-Kutta algorithm with adaptive time steps will, in general, be more efficient and accurate than same algorithm with fixed time steps. In other words, greater accuracy can usually be achieved in fewer time steps. For the given set of Daisyworld parameters and initial conditions,</p>
<ol class="arabic simple">
<li><p>Decrease the error tolerances and compare the plots. You will note that as the error tolerances are decreased, the plots approach the one created by the algorithm with fixed time steps. What does this imply?</p></li>
<li><p>Compare the Daisyworld plot to a plot of the stepsizes. Do you see a correlation between stepsize and the shape of the curve?</p></li>
<li><p>Play with the tolerances and see if you can re-create (roughly) the same plot but in fewer time steps.</p></li>
</ol>
<!-- {#lab5:sec:coding} --></div>
<div class="section" id="Coding-Runge-Kutta-Adaptive-Stepsize-Control">
<h3>Coding Runge-Kutta Adaptive Stepsize Control<a class="headerlink" href="#Coding-Runge-Kutta-Adaptive-Stepsize-Control" title="Permalink to this headline">¶</a></h3>
<p>The Runge-Kutta code developed in Lab 4 solves the given ODE system in fixed timesteps. It is now necessary to exert adaptive timestep control over the solution. The python code for this is at given in <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L145-L197">these lines</a></p>
<p>In principle, this is pretty simple:</p>
<ol class="arabic simple">
<li><p>As before, take a step specified by the Runge-Kutta algorithm.</p></li>
<li><p>Determine whether the estimated error lies within the user specified tolerance</p></li>
<li><p>If the error is too large, calculate the new stepsize with (<span class="math">\ref{eq:hnewnorm}</span>) and retake the step.</p></li>
</ol>
<p>This can be accomplished by writing a new <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L115-L117">timeloop5Err</a> method which evaluates each Runge-Kutta step. This routine must now also return the estimate of the truncation error.</p>
<p>In practice, it is prudent to take a number of safeguards. This involves defining a number of variables that place limits on the change in stepsize:</p>
<ul class="simple">
<li><p>A safety factor (<span class="math notranslate nohighlight">\(0&lt;S&lt;1\)</span>) is used when a new step is calculated to further ensure that a small enough step is taken.</p></li>
<li><p>When a step fails, i.e. the error bound equation is not satisfied,</p>
<ul>
<li><p><em>dtfailmin</em>: The new step must change by some minimum factor.</p></li>
<li><p><em>dtfailmax</em>: The step cannot change by more than some maximum factor</p></li>
<li><p><em>maxattempts</em>: A limit is placed on the number of times a step is retried.</p></li>
<li><p>A check must be made to ensure that the new step is larger than machine roundoff. (Check if <span class="math notranslate nohighlight">\(t+dt == t\)</span>.)</p></li>
</ul>
</li>
<li><p>When a step passes, i.e. equation (<span class="math">\ref{eq:hnewnorm}</span>) is satisfied,</p>
<ul>
<li><p><em>dtpassmin</em>: The step is not changed unless it is by some minimum factor.</p></li>
<li><p><em>dtpassmax</em>: The step is not changed by more than some maximum factor.</p></li>
</ul>
</li>
</ul>
<p>The only remaining question is what to take for the initial step. In theory, any step can be taken and the stepper will adjust the step accordingly. In practice, if the step is too far off, and the error is much larger than the given tolerance, the stepper will have difficulty. So some care must be taken in choosing the initial step.</p>
<p>Some safeguards can also be taken during the integration by defining,</p>
<ul class="simple">
<li><p><em>dtmin</em>: A limit placed on the smallest possible stepsize</p></li>
<li><p><em>maxsteps</em>: A limit placed on the total number of steps taken.</p></li>
</ul>
<p>The Python code for the the adaptive stepsize control is discussed further in Appendix <a class="reference external" href="#code_org">Organization</a>.</p>
<div id="prob_adaptive"><p><strong>Problem adaptive</strong></p>
</div><p>The demos in the previous section, solved the Daisyworld equations using the embedded Runge-Kutta methods with adaptive timestep control.</p>
<ol class="arabic simple">
<li><p>Run the code and find solutions of Daisyworld with the default settings found in adapt.yaml using the timeloop5Err adaptive code</p></li>
<li><p>Find the solutions again but this time with fixed stepsizes and compare the size of the timesteps and number of the timesteps.</p></li>
<li><p>How much faster does the fixed timeloop need to be to give the same performance as the adaptive timeloop for this case?</p></li>
</ol>
</div>
</div>
<div class="section" id="Daisyworld-Steady-States">
<h2>Daisyworld Steady States<a class="headerlink" href="#Daisyworld-Steady-States" title="Permalink to this headline">¶</a></h2>
<p>We can now use the Runge-Kutta code with adaptive timestep control to find some steady states of Daisyworld by varying the luminosity <span class="math notranslate nohighlight">\(LS_0\)</span> in the uservars section of adapt.yaml and recording the daisy fractions at the end of the integration. The code was used in the earlier sections to find some adhoc steady state solutions and the effect of altering some of the model parameters. What is of interest now is the effect of the daisy feedback on the range of parameter values for which
non-zero steady states exist. That the feedback does have an effect on the steady states was readily seen in a <a class="reference external" href="#prob_initial">Problem initial</a></p>
<p>If we fix all other Daisyworld parameters, we find that non-zero steady states will exist for a range of solar luminosities which we characterize by the parameter L. Recall, that L is the multiple of the solar constant <span class="math notranslate nohighlight">\(S_0\)</span> that Daisyworld receives. What we will investigate in the next few sections is the effect of the daisy feedback on the range of L for which non-zero steady states can exist.</p>
<p>We accomplish this by fixing the Daisyworld parameters and finding the resulting steady state daisy population for a given value of L. A plot is then made of the steady-state daisy populations versus various values of L.</p>
<div class="section" id="Neutral-Daisies">
<h3>Neutral Daisies<a class="headerlink" href="#Neutral-Daisies" title="Permalink to this headline">¶</a></h3>
<p>The first case we consider is the case investigated in a previous demo where the albedo of the daisies and the ground are set to the same value. This means the daisy population has no effect on the planetary temperature, i.e. there is no feedback ([lab5:demo:coupling]).</p>
<p><span class="math notranslate nohighlight">\(~\)</span></p>
<p>Daisy fraction – daisies have ground albedo</p>
<p>Emission temperature</p>
</div>
<div class="section" id="Black-Daisies">
<h3>Black Daisies<a class="headerlink" href="#Black-Daisies" title="Permalink to this headline">¶</a></h3>
<p>Now consider a population of black daisies. Note the sharp jump in the graph when the first non-zero daisy steady states appear and the corresponding rise in the planetary temperature. The appearance of the black daisies results in a strong positive feedback on the temperature. Note as well that the graph drops back to zero at a lower value of L than in the case of neutral daisies.</p>
<p>Daisies darker than ground</p>
<p>Temperature</p>
</div>
<div class="section" id="White-Daisies">
<h3>White Daisies<a class="headerlink" href="#White-Daisies" title="Permalink to this headline">¶</a></h3>
<p>Consider now a population of purely white daisies. In this case there is an abrupt drop in the daisy steady state when it approaches zero with a corresponding jump in the emission temperature. Another interesting feature is the appearance of hysteresis. This arises since the plot of steady states is different when solar luminosity is lowered as opposed to being raised incrementally.</p>
<p>Daisies brighter than ground</p>
<p>Temperature</p>
</div>
<div class="section" id="Black-and-White-Daisies">
<h3>Black and White Daisies<a class="headerlink" href="#Black-and-White-Daisies" title="Permalink to this headline">¶</a></h3>
<p>Finally, consider a population of both black and white daisies. This blends in features from the cases where the daisy population was purely white or black. Note how the appearance of a white daisy population initially causes the planetary temperature to actually drop even though the solar luminosity has been increased.</p>
<p>fraction of black and white daisies</p>
<p>note extended temperature range with stabilizing feedbacks</p>
</div>
</div>
<div class="section" id="Conclusion">
<h2>Conclusion<a class="headerlink" href="#Conclusion" title="Permalink to this headline">¶</a></h2>
<p>Black daisies can survive at lower mean temperatures than the white daisies and the reverse is true for white daisies. The end result is that the range of L for which the non-zero daisy steady states exist is greater than the case of neutral (or no) daisies . In other words, the feedback from the daisies provide a stabilizing effect that extends the set of environmental conditions in which life on Daisyworld can exist.</p>
<div id="prob_predator"><p><strong>Problem predator</strong></p>
</div><p><strong>Problem Predator</strong>: To make life a little more interesting on Daisyworld, add a population of rabbits that feed upon the daisies. The rabbit birth rate will be proportional to the area covered by the daisies while, conversely, the daisy <em>death rate</em> will be proportional to the rabbit population.</p>
<p>Add another equation to the Daisyworld model which governs the rabbit population and make the appropriate modifications to the existing daisy equations. Modify the set of equations and solve it with the Runge-Kutta method with adaptive timesteps. Use it to look for steady states and to determine their dependence on the initial conditions and model parameters.</p>
<p>Hand in notebook cells that:</p>
<ol class="arabic simple">
<li><p>Show your modified Daisyworld equations and your new integrator class.</p></li>
<li><p>At least one set of parameter values and initial conditions that leads to the steady state and a plot of the timeseries for the daisies and rabbits.</p></li>
<li><p>A discussion of the steady state’s dependence on these values, i.e. what happens when they are altered. Include a few plots for illustration.</p></li>
<li><p>Does adding this feedback extend the range of habital L values for which non-zero populations exist?</p></li>
</ol>
<p><strong>Bonus:</strong>: Now consider foxes that prey on rabbits but leave the daisies alone.</p>
</div>
<div class="section" id="Appendix:-Note-on-Global-Energy-Balance">
<h2>Appendix: Note on Global Energy Balance<a class="headerlink" href="#Appendix:-Note-on-Global-Energy-Balance" title="Permalink to this headline">¶</a></h2>
<p>The statement that the earth is in energy balance follows from the First Law of Thermodynamics, i.e.</p>
<p><strong>The energy absorbed by an isolated system is equal to the change in the internal energy minus the work extracted</strong></p>
<p>which itself is an expression of the conservation of energy.</p>
<p>For the earth, the primary source of energy is radiation from the sun. The power emitted by the sun, known as the solar luminosity, is <span class="math notranslate nohighlight">\(L_0=3.9 \times 10^{26}W\)</span> while the energy flux received at the mean distance of the earth from the sun (<span class="math notranslate nohighlight">\(1.5\times 10^{11}m\)</span>) is called the solar constant, <span class="math notranslate nohighlight">\(S_0=1367\ W m^{-2}\)</span>. For Daisy World the solar constant is taken to be <span class="math notranslate nohighlight">\(S_0=3668\ W m^{-2}\)</span>.</p>
<p>The emission temperature of a planet is the temperature the planet would be at if it emitted energy like a blackbody. A blackbody, so-called because it is a perfect absorber of radiation, obeys the Stefan-Boltzmann Law:</p>
<!-- \label{lab5:stefan-boltzmann-law} --><p><span class="math">\textbf{eq: Stefan-Boltzman}</span></p>
<div class="math notranslate nohighlight">
\[F_B\ (Wm^{-2}) = \sigma T^4_e\]</div>
<p>where <span class="math notranslate nohighlight">\(\epsilon\)</span> is the energy density and <span class="math notranslate nohighlight">\(\sigma = 5.67\times 10^{-8}Wm^{-2}K^{-4}\)</span>. Given the energy absorbed, it is easy to calculate the emission temperature <span class="math notranslate nohighlight">\(T_e\)</span> with Stefan-Boltzman equation.</p>
<p>In general, a planet will reflect some of the radiation it receives, with the fraction reflected known as the albedo <span class="math notranslate nohighlight">\(\alpha_p\)</span>. So the total energy absorbed by the planet is actually flux density received times the fraction absorbed times the perpendicular area to the sun ( the ’shadow area’), i.e.</p>
<!-- \label{lab5:energyabsorbed} --><div class="math notranslate nohighlight">
\[E_{\rm absorbed}=S_0(1-\alpha_p)\pi r_p^2\]</div>
<p>where <span class="math notranslate nohighlight">\(r^2_p\)</span> is the planet’s radius.</p>
<p>If we still assume the planet emits like a blackbody, we can calculate the corresponding blackbody emission temperature. The total power emitted would be the flux <span class="math notranslate nohighlight">\(F_B\)</span> of the blackbody times its surface area, i.e.</p>
<!-- \label{lab5:energyemitted} --><div class="math notranslate nohighlight">
\[E_{\rm blackbody} = \sigma T^4_e 4\pi  r_p^2\]</div>
<p>Equating the energy absorbed with the energy emitted by a blackbody we can calculate the emission temperature,</p>
<!-- \label{lab5:emissiontemp} --><div class="math notranslate nohighlight">
\[T^4_e = L \frac{S_0}{4\sigma}(1-\alpha_p)\]</div>
</div>
<div class="section" id="Summary:-Daisy-World-Equations">
<h2>Summary: Daisy World Equations<a class="headerlink" href="#Summary:-Daisy-World-Equations" title="Permalink to this headline">¶</a></h2>
<div class="math notranslate nohighlight">
\[\frac{dA_w}{dt} = A_w ( \beta_w x - \chi)\]</div>
<div class="math notranslate nohighlight">
\[\frac{dA_b}{dt} = A_b ( \beta_b x - \chi)\]</div>
<div class="math notranslate nohighlight">
\[x = 1 - A_w - A_b\]</div>
<div class="math notranslate nohighlight">
\[\beta_i = 1.0 - 0.003265(295.5 K -T_i)^2\]</div>
<div class="math notranslate nohighlight">
\[T^4_i = R L \frac{S_0}{4\sigma}(\alpha_p-\alpha_i) + T^4_e\]</div>
<div class="math notranslate nohighlight">
\[\alpha_p = A_w\alpha_w + A_b\alpha_b + A_g\alpha_g\]</div>
<div class="math notranslate nohighlight">
\[T^4_e = L \frac{S_0}{4\sigma}(1-\alpha_p)\]</div>
<div id="code_org"></div>
<div class="section" id="Appendix:-Organization-of-the-adaptive-Runge-Kutta-routines">
<h2>Appendix: Organization of the adaptive Runge Kutta routines<a class="headerlink" href="#Appendix:-Organization-of-the-adaptive-Runge-Kutta-routines" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The coding follows <a class="reference external" href="pdfs/adapt_ode.pdf">Press et al.</a>, with the adaptive Runge Kutta defined in the Integrator base class <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L43-L59">here</a></p></li>
<li><p>The step size choice is made in <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L115-L118">timeloop5err</a></p></li>
<li><p>To set up a specific problem, you need to overide two methods as demonstrated in the example code: the member function that initalizes the concentrations: <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L115-L118">yinit</a> and the derivatives routine <a class="reference external" href="https://github.com/phaustin/numeric/blob/10117233dc7c440b15c549c8086d76a03b9dcdd0/numlabs/lab5/lab5_funs.py#L66-L68">derivs5</a></p></li>
<li><p>In <a class="reference external" href="#prob_initial">Problem Initial</a> we define a new member function:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yvals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the temperatures over the white and black daisies</span>
<span class="sd">            and the planetary equilibrium temperature given the daisy fractions</span>

<span class="sd">            input:  yvals -- array of dimension [2] with the white [0] and black [1]</span>
<span class="sd">                    daisy fraction</span>
<span class="sd">            output:  white temperature (K), black temperature (K), equilibrium temperature (K)</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>which give an example of how to use the instance variable data (self.uservars) in additional calculations.</p>
</div>
<div class="section" id="Appendix:-2-minute-intro-to-object-oriented-programming">
<h2>Appendix: 2 minute intro to object oriented programming<a class="headerlink" href="#Appendix:-2-minute-intro-to-object-oriented-programming" title="Permalink to this headline">¶</a></h2>
<p>For a very brief introduction to python classes take a look at <a class="reference external" href="http://www.scipy-lectures.org/intro/language/oop.html">these scipy lecture notes</a> that define some of the basic concepts. For perhaps more detail than you want/need to know, see <a class="reference external" href="https://realpython.com/python-super/">supercharge your classes with super()</a> Briefly, we need a way to store a lot of information, for example the Runge-Kutta coefficients, in an organized way that is accessible to multiple functions, without having
to pass all that information through the function arguments. Python solves this problem by putting both the data and the functions together into an class, as in the Integrator class below.</p>
<div class="section" id="Classes-and-constructors">
<h3>Classes and constructors<a class="headerlink" href="#Classes-and-constructors" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Integrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Constructing Integrator&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">third</span>

    <span class="k">def</span> <span class="nf">dumpit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">the_name</span><span class="p">):</span>
        <span class="n">printlist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dumping arguments for </span><span class="si">{the_name}</span><span class="s1">: </span><span class="si">{printlist}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__()</span></code> is called the class constructor</p></li>
<li><p>a,b,c are called class attributes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dumpit()</span></code> is called a member function or method</p></li>
<li><p>We construct and instance of the class by passing the required arguments to <code class="docutils literal notranslate"><span class="pre">__init__</span></code></p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">the_integ</span> <span class="o">=</span> <span class="n">Integrator</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">the_integ</span><span class="p">))</span>
<span class="c1">#note that the_integ now has a, b, c, and dumpit</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Constructing Integrator
[&#39;__class__&#39;, &#39;__delattr__&#39;, &#39;__dict__&#39;, &#39;__dir__&#39;, &#39;__doc__&#39;, &#39;__eq__&#39;, &#39;__format__&#39;, &#39;__ge__&#39;, &#39;__getattribute__&#39;, &#39;__gt__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, &#39;__init_subclass__&#39;, &#39;__le__&#39;, &#39;__lt__&#39;, &#39;__module__&#39;, &#39;__ne__&#39;, &#39;__new__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__subclasshook__&#39;, &#39;__weakref__&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;dumpit&#39;]
</pre></div></div>
</div>
<ul class="simple">
<li><p>and we call the member function like this:</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">the_integ</span><span class="o">.</span><span class="n">dumpit</span><span class="p">(</span><span class="s1">&#39;Demo object&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dumping arguments for Demo object: [1, 2, 3]
</pre></div></div>
</div>
<p>What does this buy us? Member functions only need arguments specific to them, and can use any attribute or other member function attached to the self variable, which doesn’t need to be part of the function call.</p>
</div>
<div class="section" id="finding-the-attributes-and-methods-of-a-class-instance">
<h3>finding the attributes and methods of a class instance<a class="headerlink" href="#finding-the-attributes-and-methods-of-a-class-instance" title="Permalink to this headline">¶</a></h3>
<p>Python has a couple of functions that allow you to see the methods and attributes of objects</p>
<p>To get a complete listing of builtin and user-defined methods and attributes use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">dir</span>
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">dir</span><span class="p">(</span><span class="n">the_integ</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;__class__&#39;,
 &#39;__delattr__&#39;,
 &#39;__dict__&#39;,
 &#39;__dir__&#39;,
 &#39;__doc__&#39;,
 &#39;__eq__&#39;,
 &#39;__format__&#39;,
 &#39;__ge__&#39;,
 &#39;__getattribute__&#39;,
 &#39;__gt__&#39;,
 &#39;__hash__&#39;,
 &#39;__init__&#39;,
 &#39;__init_subclass__&#39;,
 &#39;__le__&#39;,
 &#39;__lt__&#39;,
 &#39;__module__&#39;,
 &#39;__ne__&#39;,
 &#39;__new__&#39;,
 &#39;__reduce__&#39;,
 &#39;__reduce_ex__&#39;,
 &#39;__repr__&#39;,
 &#39;__setattr__&#39;,
 &#39;__sizeof__&#39;,
 &#39;__str__&#39;,
 &#39;__subclasshook__&#39;,
 &#39;__weakref__&#39;,
 &#39;a&#39;,
 &#39;b&#39;,
 &#39;c&#39;,
 &#39;dumpit&#39;]
</pre></div></div>
</div>
<p>To see just the attributes, use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span>
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">vars</span><span class="p">(</span><span class="n">the_integ</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: 3}
</pre></div></div>
</div>
<p>The inspect.getmembers function gives you everything as a list of (name,object) tuples so you can filter the items you’re interested in. See:</p>
<p><a class="reference external" href="https://docs.python.org/3/library/inspect.html">https://docs.python.org/3/library/inspect.html</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">all_info_the_integ</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">the_integ</span><span class="p">)</span>
<span class="n">only_methods</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">all_info_the_integ</span> <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;methods for the_integ: &#39;</span><span class="p">,</span> <span class="n">only_methods</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
methods for the_integ:  [&#39;__init__&#39;, &#39;dumpit&#39;]
</pre></div></div>
</div>
</div>
<div class="section" id="Inheritance">
<h3>Inheritance<a class="headerlink" href="#Inheritance" title="Permalink to this headline">¶</a></h3>
<p>We can also specialize a class by driving from a base and then adding more data or members, or overriding existing values. For example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">class</span> <span class="nc">Trig</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="n">three</span><span class="p">,</span> <span class="n">four</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;constructing Trig&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># first construct the base class</span>
        <span class="c1">#</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="n">three</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">four</span>

    <span class="k">def</span> <span class="nf">calc_trig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_trig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">the_date</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;on </span><span class="si">{the_date}</span><span class="s1"> the value of sin(a*b)=: </span><span class="si">{self.trigval:5.3f}</span><span class="s1">&#39;</span><span class="p">)</span>


</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">Trig</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">sample</span><span class="o">.</span><span class="n">calc_trig</span><span class="p">()</span>
<span class="n">sample</span><span class="o">.</span><span class="n">print_trig</span><span class="p">(</span><span class="s1">&#39;July 5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
constructing Trig
Constructing Integrator
on July 5 the value of sin(a*b)=: -0.537
</pre></div></div>
</div>
</div>
<div class="section" id="Initializing-using-yaml">
<h3>Initializing using yaml<a class="headerlink" href="#Initializing-using-yaml" title="Permalink to this headline">¶</a></h3>
<p>To specify the intial values for the class, we use a plain text format called <a class="reference external" href="http://www.yaml.org/spec/1.2/spec.html">yaml</a>. To write a yaml file, start with a dictionary that contains entries that are themselves dictionaries:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">yaml</span>
<span class="n">out_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;vegetables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">carrots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">eggplant</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">corn</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;fruit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">apples</span><span class="o">=</span><span class="s1">&#39;Out of season&#39;</span><span class="p">,</span> <span class="n">strawberries</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;groceries.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">out_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#what&#39;s in the yaml file?</span>
<span class="c1">#each toplevel dictionary key became a category</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1">#output to sys.stdout because print adds blank lines</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;groceries.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
fruit:
  apples: Out of season
  strawberries: 8
vegetables:
  carrots: 5
  corn: 2
  eggplant: 7
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#read into a dictionary</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;groceries.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">init_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">init_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;fruit&#39;: {&#39;apples&#39;: &#39;Out of season&#39;, &#39;strawberries&#39;: 8}, &#39;vegetables&#39;: {&#39;carrots&#39;: 5, &#39;corn&#39;: 2, &#39;eggplant&#39;: 7}}
</pre></div></div>
</div>
<div id="sec_override"></div>
<div class="section" id="Overriding-initial-values-in-a-derived-class">
<h3>Overriding initial values in a derived class<a class="headerlink" href="#Overriding-initial-values-in-a-derived-class" title="Permalink to this headline">¶</a></h3>
<p>Suppose we want to change a value like the strength of the sun, <span class="math notranslate nohighlight">\(L\)</span>, after it’s been read in from the initail yaml file? Since a derived class can override the yinit function in the Integrator class, we are free to change it to overwrite any variable by reassigning the new value to self in the child constructor.</p>
<p>Here’s a simple example showing this kind of reinitialization:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">:</span>
    <span class="c1">#</span>
    <span class="c1"># this constructor is called first</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basevar</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">basevar</span>


<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="c1"># this class changes the initialization</span>
    <span class="c1"># to add a new variable</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># change the L in the child class</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
</pre></div>
</div>
</div>
<p>Now we can use Child(a,Lval) to construct instances with any value of L we want:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Lvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># now make 10 children, each with a different value of L</span>
<span class="c1">#</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">theL</span> <span class="ow">in</span> <span class="n">Lvals</span><span class="p">:</span>
    <span class="n">newItem</span> <span class="o">=</span> <span class="n">Child</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theL</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;set L value in child class to </span><span class="si">{newItem.L:3.0f}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
set L value in child class to   0
set L value in child class to  10
set L value in child class to  20
set L value in child class to  30
set L value in child class to  40
set L value in child class to  50
set L value in child class to  60
set L value in child class to  70
set L value in child class to  80
set L value in child class to  90
set L value in child class to 100
</pre></div></div>
</div>
<p>To change L in the IntegCoupling class in <a class="reference external" href="#prob_conduction">Problem Conduction</a> look at changing the value above these lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">initvars</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;initvars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">initvars</span> <span class="o">=</span> <span class="n">initvars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initvars&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="Why-bother?">
<h3>Why bother?<a class="headerlink" href="#Why-bother?" title="Permalink to this headline">¶</a></h3>
<p>What does object oriented programming buy us? The dream was that companies/coders could ship standard base classes, thoroughly tested and documented, and then users could adapt those classes to their special needs using inheritence. This turned out to be too ambitous, but a dialed-back version of this is definitely now part of many major programming languages.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../week_notes.html" class="btn btn-neutral float-right" title="Weekly notes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../lab4/01-lab4.html" class="btn btn-neutral float-left" title="Solving Ordinary Differential Equations with the Runge-Kutta Methods" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Numeric project

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>